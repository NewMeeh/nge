<ng-container *ngIf="filter.term">
  <div class="tree-filter" title="Filter">
    <span class="tree-filter__label">{{ filter.term }}</span>
    <div class="tree-filter__commands">
      <span class="command-clear" role="button" title="Clear" (click)="_clearFilter()">&times;</span>
    </div>
  </div>
</ng-container>

<cdk-virtual-scroll-viewport
  tabindex="0"
  class="tree-component"
  [class.editing]="editing.node != null"
  [itemSize]="adapter.itemHeight"
  [minBufferPx]="minBufferPx"
  [maxBufferPx]="maxBufferPx"
  [style.height]="adapter.treeHeight">
  <ng-container *cdkVirtualFor="let node of visibleNodes|async; trackBy: _trackById;">
    <!-- RENAMING -->
    <ng-container *ngIf="_isRenaming(node); else: nodeTemplate">
      <div
        class="tree-node opaque focused selected tree-node--level-{{ node.level + 1 }}"
        [attr.data-tree-node-id]="node.id"
        [style.padding-left]="node.padding"
        [style.height.px]="adapter.itemHeight">
        <div class="tree-node__content" [style.height.px]="adapter.itemHeight">
          <ng-container *ngTemplateOutlet="inputTemplate"> </ng-container>
        </div>
      </div>
    </ng-container>

    <!-- NODE -->
    <ng-template #nodeTemplate>
      <div
        class="tree-node tree-node--level-{{ node.level }}"
        [attr.data-tree-node-id]="node.id"
        [style.padding-left]="node.padding"
        [style.height.px]="adapter.itemHeight"
        [ngClass]="{
          focused: isFocused(node),
          selected: isSelected(node),
          expanded: isExpanded(node)
        }">
          <div class="tree-node__content" [style.height.px]="adapter.itemHeight" [matTooltip]="node.tooltip">
            <ng-container *ngTemplateOutlet="nodeDirective.templateRef; context: { $implicit: node }"></ng-container>
          </div>
      </div>
    </ng-template>

    <!-- CREATING -->
    <ng-container *ngIf="_isCreating(node)">
      <div
        class="tree-node opaque focused selected tree-node--level-{{ node.level + 1 }}"
        [style.padding-left]="node.padding"
        [style.height.px]="adapter.itemHeight">
        <div class="tree-node__content" [style.height.px]="adapter.itemHeight">
          <ng-container *ngTemplateOutlet="inputTemplate"> </ng-container>
        </div>
      </div>
    </ng-container>
  </ng-container>
</cdk-virtual-scroll-viewport>

<ng-template #inputTemplate>
  <span class="tree-input">
    <input
      autofocus
      type="text"
      placeholder="Press Enter to create ESC to cancel..."
      [(ngModel)]="editing.text"
      (keydown)="_onEdit($event)"
      (blur)="_onEdit($event)"/>
  </span>
</ng-template>
